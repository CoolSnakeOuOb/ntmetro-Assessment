<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒæ ¸ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="top-bar">
        <h5><a href="homepage.html">æ–°åŒ—æ·é‹å…¬å¸è€ƒæ ¸ç³»çµ±</a></h5>
        <button type="button" class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
        <div>
            <span id="username" class="text-white me-3"></span>
            <button id="logout-btn" class="btn btn-danger">ç™»å‡º</button>
        </div>
    </div>
    <div class="main-container">
        <div id="sidebar"></div>

        <div id="content">
            <div id="supervisor-view" style="display: none;">
                <div class="frame mb-4">
                    <h4>è³‡æ–™åŒ¯å…¥</h4>
                    <hr>
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <label for="employeeListFile" class="form-label">1. å“¡å·¥åå–® (Excel)</label>
                            <input type="file" class="form-control mb-2" id="employeeListFile" accept=".xls,.xlsx">
                            <label for="leaveFile" class="form-label">2. è«‹å‡æ˜ç´° (Excel æ¨ç´è¡¨)</label>
                            <input type="file" class="form-control" id="leaveFile" accept=".xls,.xlsx">
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" type="button" id="uploadBtn">ä¸Šå‚³ä¸¦è‡ªå‹•ç¯©é¸</button>
                        </div>
                    </div>
                    <div id="upload-status" class="mt-2 small text-muted"></div>
                </div>
                 <div class="frame">
                    <h4>å¾…è©•æ ¸åŒä»åˆ—è¡¨</h4>
                    <hr>
                    <table id="appraisalTable" class="display" style="width:100%"></table>
                </div>
            </div>

            <div id="allocation-view" style="display: none;">
                <div class="frame mb-4">
                    <h4>å–®ä½çš„ç­‰ç¬¬å“¡é¡åˆ†é… (åŸºç¤çµ±è¨ˆ)</h4>
                    <hr>
                    <div class="alert alert-info">
                        <strong>çµ±è¨ˆèªªæ˜ï¼š</strong> 
                        æœ¬è¡¨çµ±è¨ˆå„å–®ä½ç¬¦åˆ <strong>ã€Œå¹´è€ƒã€</strong> èˆ‡ <strong>ã€Œå¦è€ƒã€</strong> è³‡æ ¼ä¹‹åŒä»äººæ•¸ã€‚
                    </div>
                    <table id="allocationTable" class="display" style="width:100%"></table>
                </div>
            </div>

            <div id="employee-view" style="display: none;">
                <form id="trialPeriodForm">
                    <div class="frame">
                        <div class="frame-header"><span class="header-icon">ğŸ“‹</span><span class="header-title">è‡ªè©•è¡¨åŸºæœ¬è³‡æ–™</span></div>
                        <div class="frame-body">
                           <div class="row mb-3"><div class="col-md-6"><label class="form-label">ä¸»è¾¦æ¥­å‹™:</label><input type="text" class="form-control"></div><div class="col-md-6"><label class="form-label">å°ˆæ¥­:</label><input type="text" class="form-control"></div></div>
                           <div class="row mb-3"><div class="col-md-6"><label class="form-label">è©¦ç”¨æœŸé–“ï¼ˆèµ·ï¼‰:</label><input type="date" class="form-control"></div><div class="col-md-6"><label class="form-label">è©¦ç”¨æœŸé–“ï¼ˆæ­¢ï¼‰:</label><input type="date" class="form-control"></div></div>
                        </div>
                    </div>
                    <div class="frame">
                        <div class="frame-header"><span class="header-icon">ğŸ“‹</span><span class="header-title">è‡ªæˆ‘è©•åƒ¹</span></div>
                        <div class="frame-body">
                           <div class="row mb-3"><div class="col-md-6"><label class="form-label">1. å°è©¦ç”¨æœŸé–“åœ¨å…¬å¸çš„è¡¨ç¾æ„Ÿåˆ°ï¼š</label><select class="form-select"><option>éå¸¸æ»¿æ„</option><option>æ»¿æ„</option><option>å°šå¯</option><option>ä¸æ»¿æ„</option></select></div><div class="col-md-6"><label class="form-label">2. å°èˆ‡åŒäº‹èˆ‡ä¸»ç®¡é–“é—œä¿‚æ„Ÿåˆ°ï¼š</label><select class="form-select"><option>éå¸¸æ»¿æ„</option><option>æ»¿æ„</option><option>å°šå¯</option><option>ä¸æ»¿æ„</option></select></div></div>
                           <div class="row mb-3"><div class="col-md-12"><label class="form-label">9. å°æ‚¨æ‰€å¾æ“”ä»»è·å‹™å¸Œæœ›ï¼š</label><select class="form-select" id="se_9"><option value="1">ç¹¼çºŒæ“”ä»»ç¾è·</option><option value="2">å¦‚èƒ½èª¿æ•´è‡³åŒå–®ä½____è·å‹™</option><option value="3">å¦‚å¯è®Šæ›´è‡³____å–®ä½____è·å‹™</option></select><input type="text" id="position_change" class="form-control mt-2" style="display: none;"><input type="text" id="unit_change" class="form-control mt-2" style="display: none;"></div></div>
                        </div>
                    </div>
                    <div class="mt-3 mb-3"><button type="button" class="btn btn-primary w-100 fs-4" style="background-color: #2d5986;">ğŸ“¤ é€å‡º</button></div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="share.js"></script>
    <script src="data_processor.js"></script>

    <script>
        $(document).ready(function() {
            let globalEmployeeData = [];
            let table = null;

            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!loggedInUser) { window.location.href = 'index.html'; return; }
            $('#username').text(`æ­¡è¿, ${loggedInUser.name}`);

            if (loggedInUser.role === 'supervisor') {
                $('#supervisor-view').show();
                renderSupervisorSidebar();
                initializeSupervisorTable();

                $('#uploadBtn').on('click', function() {
                    const employeeListFile = $('#employeeListFile')[0].files[0];
                    const leaveFile = $('#leaveFile')[0].files[0];

                    if (!employeeListFile || !leaveFile) {
                        $('#upload-status').text('è«‹åŒæ™‚é¸æ“‡æª”æ¡ˆï¼').addClass('text-danger'); return;
                    }
                    $('#upload-status').text('è™•ç†ä¸­...').removeClass('text-danger').addClass('text-muted');

                    Promise.all([
                        readExcelFile(employeeListFile, ['å“¡å·¥å·¥è™Ÿ']),
                        readExcelFile(leaveFile, ['å“¡å·¥å·¥è™Ÿ', 'åˆè¨ˆ'])
                    ]).then(([employeeData, leaveData]) => {
                        if (!employeeData) { $('#upload-status').text('å“¡å·¥åå–®éŒ¯èª¤').addClass('text-danger'); return; }
                        if (!leaveData) { $('#upload-status').text('è«‹å‡æ˜ç´°éŒ¯èª¤').addClass('text-danger'); return; }

                        const leaveMap = processLeaveData(leaveData); 
                        const processedData = processEmployeeData(employeeData, leaveMap);
                        globalEmployeeData = processedData;

                        if(table) { table.clear().rows.add(processedData).draw(); }
                        $('#upload-status').text('æˆåŠŸåŒ¯å…¥ï¼').removeClass('text-danger').addClass('text-success');
                    }).catch(e => { console.error(e); $('#upload-status').text('å¤±æ•—ï¼Œè«‹æª¢æŸ¥F12').addClass('text-danger'); });
                });

                $(document).on('click', '#menu-home', function(e) {
                    e.preventDefault(); $('#supervisor-view').show(); $('#allocation-view').hide();
                });

                $(document).on('click', '#menu-allocation', function(e) {
                    e.preventDefault();
                    if (globalEmployeeData.length === 0) { alert("è«‹å…ˆä¸Šå‚³å“¡å·¥åå–®"); return; }
                    $('#supervisor-view').hide(); $('#allocation-view').show();
                    calculateAndRenderAllocation();
                });

            } else {
                $('#employee-view').show();
                renderEmployeeSidebar();
                $('#se_9').on('change', function() {
                    if (this.value === '2') { $('#position_change').show(); $('#unit_change').hide(); }
                    else if (this.value === '3') { $('#unit_change').show(); $('#position_change').hide(); }
                    else { $('#position_change').hide(); $('#unit_change').hide(); }
                });
            }

            $('#logout-btn').on('click', function() { sessionStorage.removeItem('loggedInUser'); window.location.href = 'index.html'; });

            function renderSupervisorSidebar() {
                // ç§»é™¤äº† "ä¸äºˆè€ƒæ ¸" çš„ç¯©é¸æŒ‰éˆ•ï¼ŒåŠ å…¥ "ç‰¹è€ƒ"
                const sidebarHtml = `
                    <div>
                        <a href="#" id="menu-home" class="itemToggle">é¦–é ï¼ˆè€ƒæ ¸åå–®ï¼‰</a>
                        <a href="#" id="menu-allocation" class="itemToggle">å–®ä½çš„ç­‰ç¬¬å“¡é¡åˆ†é…</a>
                        <hr style="border-color: #555;">
                        <a href="#" class="itemToggle">åŒä»è€ƒæ ¸ç¯©é¸<span class="arrow">â–¼</span></a>
                        <div class="submenu"><a href="#" id="filterAnnual">ï¼å¹´è€ƒ</a><a href="#" id="filterSpecial">ï¼å¦è€ƒ</a><a href="#" id="filterSpecialExam">ï¼ç‰¹è€ƒ</a></div>
                    </div>`;
                $('#sidebar').html(sidebarHtml);
                $('#filterAnnual').on('click', ()=> table.column(6).search('å¹´è€ƒ').draw());
                $('#filterSpecial').on('click', ()=> table.column(6).search('å¦è€ƒ').draw());
                $('#filterSpecialExam').on('click', ()=> table.column(6).search('ç‰¹è€ƒ').draw());
            }

            function initializeSupervisorTable() {
                table = $('#appraisalTable').DataTable({
                    "data": [],
                    "columns": [
                        { "data": 'employeeId', "title": "å“¡å·¥å·¥è™Ÿ" },
                        { "data": 'name', "title": "å§“å" },
                        { "data": 'department', "title": "éƒ¨é–€" },
                        { "data": 'jobTitle', "title": "è·å‹™" },
                        { "data": 'hireDate', "title": "åˆ°è·æ—¥" },
                        { "data": 'totalLeave', "title": "è«‹å‡(å¤©)"},
                        { 
                            "data": 'appraisalType', 
                            "title": "è€ƒæ ¸é¡åˆ¥",
                            "render": function(data, type, row) {
                                if (type === 'display') {
                                    // *** ä¿®æ­£ï¼šåªä¿ç•™ 3 ç¨®é¸é … ***
                                    const options = ['å¹´è€ƒ', 'å¦è€ƒ', 'ç‰¹è€ƒ'];
                                    let select = `<select class="form-select form-select-sm appraisal-select" data-id="${row.employeeId}">`;
                                    options.forEach(opt => {
                                        const isSelected = data === opt ? 'selected' : '';
                                        let style = '';
                                        if(opt === 'ç‰¹è€ƒ') style = 'color:blue; font-weight:bold;';
                                        
                                        select += `<option value="${opt}" ${isSelected} style="${style}">${opt}</option>`;
                                    });
                                    select += `</select>`;
                                    return select;
                                }
                                return data;
                            }
                        },
                        { "data": null, "title": "æ“ä½œ", "render": r => `<a href="appraisal_form.html?employeeId=${r.employeeId}" class="btn btn-primary btn-sm">é€²è¡Œè©•æ ¸</a>`, "orderable": false }
                    ],
                    "language": { "url": "https://cdn.datatables.net/plug-ins/1.11.5/i18n/zh-HANT.json" }
                });

                $('#appraisalTable tbody').on('change', '.appraisal-select', function() {
                    const newVal = $(this).val();
                    const empId = $(this).data('id');
                    const row = table.row($(this).closest('tr'));
                    const rowData = row.data();
                    rowData.appraisalType = newVal;
                    table.row($(this).closest('tr')).data(rowData).invalidate();

                    const globalItem = globalEmployeeData.find(item => item.employeeId == empId);
                    if(globalItem) { globalItem.appraisalType = newVal; }
                });
            }

            function calculateAndRenderAllocation() {
                const deptStats = {};
                globalEmployeeData.forEach(emp => {
                    const dept = emp.department;
                    const type = emp.appraisalType;
                    if (!deptStats[dept]) { deptStats[dept] = { annual: 0, special: 0, total: 0 }; }

                    if (type === 'å¹´è€ƒ') {
                        deptStats[dept].annual++;
                        deptStats[dept].total++;
                    } else if (type === 'å¦è€ƒ') {
                        deptStats[dept].special++;
                        deptStats[dept].total++;
                    }
                    // ç‰¹è€ƒé€šå¸¸ä¸ç®—å…¥å¸¸æ…‹åˆ†é…åŸºæ•¸ï¼Œè‹¥æ‚¨éœ€è¦ç®—å…¥ï¼Œè«‹å–æ¶ˆä¸‹æ–¹è¨»è§£
                    // else if (type === 'ç‰¹è€ƒ') { deptStats[dept].total++; }
                });

                const tableData = Object.keys(deptStats).map(d => ({ deptName: d, stats: deptStats[d] }));
                if ($.fn.DataTable.isDataTable('#allocationTable')) { $('#allocationTable').DataTable().destroy(); }

                $('#allocationTable').DataTable({
                    data: tableData,
                    columns: [
                        { title: "å–®ä½åç¨±", data: "deptName" },
                        { title: "å¹´è€ƒäººæ•¸", data: "stats.annual" },
                        { title: "å¦è€ƒäººæ•¸", data: "stats.special" },
                        { title: "è€ƒæ ¸åŸºæ•¸ (åˆè¨ˆ)", data: "stats.total", className: "fw-bold text-center bg-light" }
                    ],
                    language: { "url": "https://cdn.datatables.net/plug-ins/1.11.5/i18n/zh-HANT.json" },
                    dom: 'Bfrtip',
                    order: [[3, 'desc']]
                });
            }
        });
    </script>
</body>
</html>