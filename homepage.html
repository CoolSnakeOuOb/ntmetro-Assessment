<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒæ ¸ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="top-bar">
        <h5><a href="homepage.html">æ–°åŒ—æ·é‹å…¬å¸è€ƒæ ¸ç³»çµ±</a></h5>
        <button type="button" class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
        <div>
            <span id="username" class="text-white me-3"></span>
            <button id="logout-btn" class="btn btn-danger">ç™»å‡º</button>
        </div>
    </div>
    <div class="main-container">
        <div id="sidebar"></div>

        <div id="content">
            <div id="supervisor-view" style="display: none;">
                <div class="frame mb-4">
                    <h4>è³‡æ–™åŒ¯å…¥</h4>
                    <hr>
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <label for="employeeListFile" class="form-label">1. å“¡å·¥åå–® (Excel)</label>
                            <input type="file" class="form-control mb-2" id="employeeListFile" accept=".xls,.xlsx">
                            <label for="leaveFile" class="form-label">2. è«‹å‡æ˜ç´° (Excel æ¨ç´è¡¨)</label>
                            <input type="file" class="form-control" id="leaveFile" accept=".xls,.xlsx">
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" type="button" id="uploadBtn">ä¸Šå‚³ä¸¦è‡ªå‹•ç¯©é¸</button>
                        </div>
                    </div>
                    <div id="upload-status" class="mt-2 small text-muted"></div>
                </div>
                 <div class="frame">
                    <h4>å¾…è©•æ ¸åŒä»åˆ—è¡¨</h4>
                    <hr>
                    <table id="appraisalTable" class="display" style="width:100%"></table>
                </div>
            </div>

            <div id="employee-view" style="display: none;">
                <form id="trialPeriodForm">
                    <div class="frame">
                        <div class="frame-header">
                            <span class="header-icon">ğŸ“‹</span>
                            <span class="header-title" style="font-size: 20px;">è‡ªè©•è¡¨åŸºæœ¬è³‡æ–™</span>
                        </div>
                        <div class="frame-body">
                            <div class="row mb-3">
                                <div class="col-md-6"><label for="hostingbusiness" class="form-label">ä¸»è¾¦æ¥­å‹™:</label><input type="text" class="form-control" id="hostingbusiness"></div>
                                <div class="col-md-6"><label for="major" class="form-label">å°ˆæ¥­:</label><input type="text" class="form-control" id="major"></div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6"><label for="dayfrom" class="form-label">è©¦ç”¨æœŸé–“ï¼ˆèµ·ï¼‰:</label><input type="date" class="form-control" id="dayfrom"></div>
                                <div class="col-md-6"><label for="dayto" class="form-label">è©¦ç”¨æœŸé–“ï¼ˆæ­¢ï¼‰:</label><input type="date" class="form-control" id="dayto"></div>
                            </div>
                        </div>
                    </div>
                    <div class="frame">
                        <div class="frame-header">
                            <span class="header-icon">ğŸ“‹</span>
                            <span class="header-title" style="font-size: 20px;">è‡ªæˆ‘è©•åƒ¹</span>
                        </div>
                        <div class="frame-body">
                            <div class="row mb-3">
                                <div class="col-md-6"><label for="se_1" class="form-label">1. å°è©¦ç”¨æœŸé–“åœ¨å…¬å¸çš„è¡¨ç¾æ„Ÿåˆ°ï¼š</label><select class="form-select" id="se_1"><option value="1">éå¸¸æ»¿æ„</option><option value="2">æ»¿æ„</option><option value="3">å°šå¯</option><option value="4">ä¸æ»¿æ„</option></select></div>
                                <div class="col-md-6"><label for="se_2" class="form-label">2. å°èˆ‡åŒäº‹èˆ‡ä¸»ç®¡é–“é—œä¿‚æ„Ÿåˆ°ï¼š</label><select class="form-select" id="se_2"><option value="1">éå¸¸æ»¿æ„</option><option value="2">æ»¿æ„</option><option value="3">å°šå¯</option><option value="4">ä¸æ»¿æ„</option></select></div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6"><label for="se_3" class="form-label">3. å°ç›®å‰çš„å·¥ä½œç’°å¢ƒæ„Ÿåˆ°ï¼š</label><select class="form-select" id="se_3"><option value="1">éå¸¸æ»¿æ„</option><option value="2">æ»¿æ„</option><option value="3">å°šå¯</option><option value="4">ä¸æ»¿æ„</option></select></div>
                                <div class="col-md-6"><label for="se_4" class="form-label">4. å°ç›®å‰çš„å·¥ä½œæ™‚é–“æ„Ÿåˆ°ï¼š</label><select class="form-select" id="se_4"><option value="1">å¤ªé•·</option><option value="2">ç¨é•·</option><option value="3">å‰›å¥½</option><option value="4">ä¸æ¸…æ¥š</option></select></div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6"><label for="se_5" class="form-label">5. å°ç›®å‰çš„å¾…é‡æ„Ÿåˆ°ï¼š</label><select class="form-select" id="se_5"><option value="1">å¾ˆå¥½</option><option value="2">åˆé©</option><option value="3">ç¨å°‘</option><option value="4">å¤ªå°‘</option></select></div>
                                <div class="col-md-6"><label for="se_6" class="form-label">6. å°ç›®å‰çš„å·¥ä½œæ„Ÿåˆ°ï¼š</label><select class="form-select" id="se_6"><option value="1">å°šèƒ½æ“”ç•¶æ›´å›°é›£å·¥ä½œ</option><option value="2">åˆé©ï¼Œä½†å¸Œæœ›æ“”ä»»æ›´å›°é›£å·¥ä½œ</option><option value="3">æ­£é©åˆç›®å‰æœ¬èº«èƒ½åŠ›</option><option value="4">èƒ½åŠ›ç¨æ„Ÿä¸è¶³</option></select></div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6"><label for="se_7" class="form-label">7. å°ç›®å‰çš„å·¥ä½œé‡æ„Ÿåˆ°ï¼š</label><select class="form-select" id="se_7"><option value="1">å¤ªå¤š</option><option value="2">ç¨å¾®å¤š</option><option value="3">é©ä¸­</option></select></div>
                                <div class="col-md-6"><label for="se_8" class="form-label">8. å°ç›®å‰å–®ä½å·¥ä½œåˆ†é…æ„Ÿåˆ°ï¼š</label><select class="form-select" id="se_8"><option value="1">åˆç†</option><option value="2">æ‡‰åšé©ç•¶èª¿æ•´</option><option value="3">ä¸åˆç†</option></select></div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12"><label for="se_9" class="form-label">9. å°æ‚¨æ‰€å¾æ“”ä»»è·å‹™å¸Œæœ›ï¼š</label><select class="form-select" id="se_9"><option value="1">ç¹¼çºŒæ“”ä»»ç¾è·</option><option value="2">å¦‚èƒ½èª¿æ•´è‡³åŒå–®ä½____è·å‹™ï¼Œç†ç”±ï¼š________</option><option value="3">å¦‚å¯è®Šæ›´è‡³____å–®ä½____è·å‹™ï¼Œç†ç”±ï¼š________</option></select><input type="text" id="position_change" class="form-control mt-2" placeholder="è«‹å¡«å¯«ï¼šèª¿æ•´è‡³åŒå–®ä½____è·å‹™ï¼Œç†ç”±ï¼š________" style="display: none;"><input type="text" id="unit_change" class="form-control mt-2" placeholder="è«‹å¡«å¯«ï¼šè®Šæ›´è‡³____å–®ä½____è·å‹™ï¼Œç†ç”±ï¼š________" style="display: none;"></div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12"><label for="se_10" class="form-label">10. æ–¼è©¦ç”¨æœŸé–“æ›¾ç¶“è¾¦ç†é‡é»ã€é‡å¤§ã€è¼ƒé‡è¦ä¹‹å·¥ä½œäº‹è¹Ÿï¼š</label><input type="text" class="form-control" id="se_10"></div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6"><label for="se_10_1" class="form-label">(1) å°æ–¼è©²å·¥ä½œè¦æ±‚ç›®æ¨™é”æˆåº¦æ„Ÿåˆ°ï¼š</label><select class="form-select" id="se_10_1"><option value="1">éå¸¸æ»¿æ„</option><option value="2">æ»¿æ„</option><option value="3">å°šå¯</option><option value="4">ä¸æ»¿æ„</option></select></div>
                                <div class="col-md-6"><label for="se_10_2" class="form-label">(2) å°æ–¼è©²å·¥ä½œå®‰æ’åŠé€²åº¦æŒæ§æ„Ÿåˆ°ï¼š</label><select class="form-select" id="se_10_2"><option value="1">éå¸¸æ»¿æ„</option><option value="2">æ»¿æ„</option><option value="3">å°šå¯</option><option value="4">ä¸æ»¿æ„</option></select></div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6"><label for="se_10_3" class="form-label">(3) å°æ–¼è©²å·¥ä½œè‡ªä¸»åˆ¤æ–·åŠåŸ·è¡Œæ„Ÿåˆ°ï¼š</label><select class="form-select" id="se_10_3"><option value="1">éå¸¸æ»¿æ„</option><option value="2">æ»¿æ„</option><option value="3">å°šå¯</option><option value="4">ä¸æ»¿æ„</option></select></div>
                                <div class="col-md-6"><label for="se_10_4" class="form-label">(4) å°æ–¼è©²å·¥ä½œåˆ†ææ€è€ƒå‘¨å»¶æ€§æ„Ÿåˆ°ï¼š</label><select class="form-select" id="se_10_4"><option value="1">éå¸¸æ»¿æ„</option><option value="2">æ»¿æ„</option><option value="3">å°šå¯</option><option value="4">ä¸æ»¿æ„</option></select></div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4"><label for="se_10_5" class="form-label">(5) å°æ–¼è©²å·¥ä½œå•é¡Œç•Œå®šåŠæ±ºç­–æ„Ÿåˆ°ï¼š</label><select class="form-select" id="se_10_5"><option value="1">éå¸¸æ»¿æ„</option><option value="2">æ»¿æ„</option><option value="3">å°šå¯</option><option value="4">ä¸æ»¿æ„</option></select></div>
                                <div class="col-md-4"><label for="se_10_6" class="form-label">(6) å°æ–¼è©²å·¥ä½œå‰µæ–°åŠå°ˆæ¥­é‹ç”¨æ„Ÿåˆ°ï¼š</label><select class="form-select" id="se_10_6"><option value="1">éå¸¸æ»¿æ„</option><option value="2">æ»¿æ„</option><option value="3">å°šå¯</option><option value="4">ä¸æ»¿æ„</option></select></div>
                                <div class="col-md-4"><label for="se_10_7" class="form-label">(7) å°æ–¼è©²å·¥ä½œåŸ·è¡Œèˆ‡å®Œæˆå“è³ªæ„Ÿåˆ°ï¼š</label><select class="form-select" id="se_10_7"><option value="1">éå¸¸æ»¿æ„</option><option value="2">æ»¿æ„</option><option value="3">å°šå¯</option><option value="4">ä¸æ»¿æ„</option></select></div>
                            </div>
                        </div>
                    </div>
                    <div class="frame">
                        <div class="frame-header">
                            <span class="header-icon">ğŸ“‹</span>
                            <span class="header-title" style="font-size: 20px;">å»ºè­°äº‹é …</span>
                        </div>
                        <div class="frame-body">
                            <div class="row mb-3">
                                <div class="col-md-6"><label for="suggestion_director" class="form-label">è©¦ç”¨æœŸé–“å°ä¸»ç®¡é ˜å°ç›£ç£ä¹‹å»ºè­°ï¼š</label><input type="text" class="form-control" id="suggestion_director"></div>
                                <div class="col-md-6"><label for="suggestion_else" class="form-label">å…¶ä»–å»ºè­°äº‹é …ï¼š</label><input type="text" class="form-control" id="suggestion_else"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 mb-3">
                        <button type="button" class="btn btn-primary w-100 fs-4" id="sybmitform" style="background-color: #2d5986;">ğŸ“¤ é€å‡º</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="share.js"></script>
    <script src="data_processor.js"></script>

    <script>
        $(document).ready(function() {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));

            if (!loggedInUser) {
                window.location.href = 'index.html';
                return;
            }

            $('#username').text(`æ­¡è¿, ${loggedInUser.name}`);

            if (loggedInUser.role === 'supervisor') {
                $('#supervisor-view').show();
                renderSupervisorSidebar();
                initializeSupervisorTable();

                // ä¸Šå‚³æŒ‰éˆ•é‚è¼¯
                $('#uploadBtn').on('click', function() {
                    const employeeListFile = $('#employeeListFile')[0].files[0];
                    const leaveFile = $('#leaveFile')[0].files[0];

                    if (!employeeListFile || !leaveFile) {
                        $('#upload-status').text('è«‹åŒæ™‚é¸æ“‡å“¡å·¥åå–®å’Œè«‹å‡æ˜ç´°æª”æ¡ˆï¼').removeClass('text-success').addClass('text-danger');
                        return;
                    }

                    $('#upload-status').text('è™•ç†ä¸­ï¼Œè«‹ç¨å€™...').removeClass('text-danger').addClass('text-muted');

                    Promise.all([
                        // 1. è®€å–å“¡å·¥åå–®ï¼šåªè¦æ‰¾åˆ°åŒ…å« "å“¡å·¥å·¥è™Ÿ" çš„åˆ†é å³å¯
                        readExcelFile(employeeListFile, ['å“¡å·¥å·¥è™Ÿ']),
                        
                        // 2. è®€å–è«‹å‡æ˜ç´°ï¼š***é—œéµä¿®æ”¹*** å¿…é ˆæ‰¾åˆ°åŒæ™‚åŒ…å« "å“¡å·¥å·¥è™Ÿ" å’Œ "åˆè¨ˆ" çš„åˆ†é 
                        // é€™æ¨£å°±èƒ½é¿é–‹åªæœ‰åŸå§‹è³‡æ–™çš„ RATT005 åˆ†é 
                        readExcelFile(leaveFile, ['å“¡å·¥å·¥è™Ÿ', 'åˆè¨ˆ'])
                    ]).then(([employeeData, leaveData]) => {
                        
                        if (!employeeData) {
                            $('#upload-status').text('å“¡å·¥åå–®éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°åŒ…å«ã€Œå“¡å·¥å·¥è™Ÿã€çš„åˆ†é ã€‚').removeClass('text-success').addClass('text-danger');
                            return;
                        }
                        // å¦‚æœ readExcelFile å›å‚³ nullï¼Œä»£è¡¨æ²’æ‰¾åˆ°ç¬¦åˆé—œéµå­—çš„åˆ†é 
                        if (!leaveData) {
                            $('#upload-status').text('è«‹å‡æ˜ç´°éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°åŒæ™‚åŒ…å«ã€Œå“¡å·¥å·¥è™Ÿã€èˆ‡ã€Œåˆè¨ˆã€çš„åˆ†é ã€‚è«‹ç¢ºèªæ‚¨é¸æ“‡çš„æ˜¯åŒ…å«æ¨ç´åˆ†æè¡¨çš„æª”æ¡ˆã€‚').removeClass('text-success').addClass('text-danger');
                            return;
                        }

                        // è³‡æ–™è™•ç† (åˆ©ç”¨è‡ªå‹•æœå°‹æ¨™é¡ŒåŠŸèƒ½)
                        const leaveMap = processLeaveData(leaveData); 
                        const processedData = processEmployeeData(employeeData, leaveMap);
                        
                        // æ›´æ–°è¡¨æ ¼
                        const table = $('#appraisalTable').DataTable();
                        table.clear().rows.add(processedData).draw();
                        
                        $('#upload-status').text('æˆåŠŸåŒ¯å…¥ä¸¦è‡ªå‹•ç¯©é¸ï¼').removeClass('text-danger').addClass('text-success');

                    }).catch(error => {
                        console.error('æª”æ¡ˆè™•ç†å¤±æ•—:', error);
                        $('#upload-status').text('æª”æ¡ˆè™•ç†å¤±æ•—ï¼Œè«‹æŒ‰ F12 æŸ¥çœ‹è©³ç´°éŒ¯èª¤è¨Šæ¯ã€‚').removeClass('text-success').addClass('text-danger');
                    });
                });

            } else {
                $('#employee-view').show();
                renderEmployeeSidebar();
                
                $('#se_9').on('change', function() {
                    const input_1 = $('#position_change');
                    const input_2 = $('#unit_change');
                    if (this.value === '2') {
                        input_1.show();
                        input_2.hide().val('');
                    } else if (this.value === '3') {
                        input_2.show();
                        input_1.hide().val('');
                    } else {
                        input_1.hide().val('');
                        input_2.hide().val('');
                    }
                });
            }

            $('#logout-btn').on('click', function() {
                sessionStorage.removeItem('loggedInUser');
                window.location.href = 'index.html';
            });

            function renderSupervisorSidebar() {
                const sidebarHtml = `
                    <div>
                        <a href="#" id="filterAll" class="itemToggle">é¦–é ï¼ˆé¡¯ç¤ºå…¨éƒ¨ï¼‰</a>
                        <a href="#" class="itemToggle">åŒä»å¹´åº¦è€ƒæ ¸<span class="arrow">â–¼</span></a>
                        <div class="submenu"><a href="#" id="filterAnnual">ï¼è€ƒæ ¸è¡¨</a></div>
                        <a href="#" class="itemToggle">åŒä»å¦äºˆè€ƒæ ¸<span class="arrow">â–¼</span></a>
                        <div class="submenu"><a href="#" id="filterSpecial">ï¼è€ƒæ ¸è¡¨</a></div>
                        <a href="#" class="itemToggle">åŒä»è©¦ç”¨æœŸè€ƒæ ¸<span class="arrow">â–¼</span></a>
                        <div class="submenu"><a href="#" id="filterProbation">ï¼è€ƒæ ¸è¡¨</a></div>
                        <a href="#" class="itemToggle">åŒä»ç‰¹è€ƒ<span class="arrow">â–¼</span></a>
                        <div class="submenu"><a href="#" id="filterSpecialExam">ï¼è€ƒæ ¸è¡¨</a></div>
                    </div>`;
                $('#sidebar').html(sidebarHtml);
                let toggles = document.querySelectorAll(".itemToggle");
                toggles.forEach(function (toggle) {
                    let submenu = toggle.nextElementSibling;
                    if (submenu && submenu.classList.contains("submenu")) {
                        submenu.style.display = "none";
                    }
                });
            }

            function renderEmployeeSidebar() {
                const sidebarHtml = `<div><a href="#">å¡«å¯«è‡ªè©•è¡¨</a><a href="#">æŸ¥çœ‹æˆ‘çš„è€ƒæ ¸ç´€éŒ„</a></div>`;
                $('#sidebar').html(sidebarHtml);
            }

            function initializeSupervisorTable() {
                let table = $('#appraisalTable').DataTable({
                    "data": [],
                    "columns": [
                        { "data": 'employeeId', "title": "å“¡å·¥å·¥è™Ÿ" },
                        { "data": 'name', "title": "å§“å" },
                        { "data": 'department', "title": "éƒ¨é–€" },
                        { "data": 'jobTitle', "title": "è·å‹™" },
                        { "data": 'hireDate', "title": "åˆ°è·æ—¥" },
                        { "data": 'totalLeave', "title": "è«‹å‡(å¤©)"},
                        { 
                            "data": 'appraisalType', "title": "è€ƒæ ¸é¡åˆ¥",
                            "render": function(data) {
                                // è®“ä¸äºˆè€ƒæ ¸é¡¯ç¤ºç´…è‰²ï¼Œæ¯”è¼ƒæ˜é¡¯
                                let color = data.includes('ä¸äºˆ') ? 'text-danger fw-bold' : '';
                                return `<span class="${color}">${data}</span>`;
                            }
                        },
                        {
                            "data": null, "title": "æ“ä½œ",
                            "render": function(data, type, row) {
                                return `<a href="appraisal_form.html?employeeId=${row.employeeId}" class="btn btn-primary btn-sm">é€²è¡Œè©•æ ¸</a>`;
                            },
                            "orderable": false
                        }
                    ],
                    "language": { "url": "https://cdn.datatables.net/plug-ins/1.11.5/i18n/zh-HANT.json" }
                });

                // ç¯©é¸å™¨ç¶å®š (æ¬„ä½ç´¢å¼• 6 æ˜¯è€ƒæ ¸é¡åˆ¥)
                $('#filterAll').on('click', function(e) { e.preventDefault(); table.column(6).search('').draw(); });
                $('#filterAnnual').on('click', function(e) { e.preventDefault(); table.column(6).search('å¹´è€ƒ').draw(); });
                $('#filterSpecial').on('click', function(e) { e.preventDefault(); table.column(6).search('å¦è€ƒ').draw(); });
                $('#filterProbation').on('click', function(e) { e.preventDefault(); table.column(6).search('ä¸äºˆ').draw(); }); 
                $('#filterSpecialExam').on('click', function(e) { e.preventDefault(); table.column(6).search('ç‰¹è€ƒ').draw(); });
            }
        });
    </script>
</body>
</html>